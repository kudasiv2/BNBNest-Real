<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNBNest - Smart Investment Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
    <style>
        /* CSS tetap sama seperti sebelumnya */
        :root {
            --pink: #ff2d75;
            --navy: #0f1a3a;
            --purple: #8a2be2;
            --light-purple: #b19cd9;
            --dark-navy: #0a1128;
            --gradient: linear-gradient(135deg, var(--pink), var(--purple));
            --glow: 0 0 10px rgba(255, 45, 117, 0.7), 0 0 20px rgba(138, 43, 226, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--dark-navy);
            color: white;
            overflow-x: hidden;
        }

        /* ... CSS lainnya tetap sama ... */
    </style>
</head>
<body>
    <!-- HTML struktur tetap sama seperti sebelumnya -->
    <header>
        <!-- Header content sama -->
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <!-- Menu content sama -->
    </div>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <!-- Hero content sama -->
    </section>

    <!-- Why Section -->
    <section id="why">
        <!-- Why content sama -->
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard">
        <!-- Dashboard content sama -->
    </section>

    <!-- Invest Section -->
    <section id="invest">
        <!-- Invest content sama -->
    </section>

    <!-- Referral Section -->
    <section id="referral">
        <!-- Referral content sama -->
    </section>

    <!-- Salary Section -->
    <section id="salary">
        <!-- Salary content sama -->
    </section>

    <!-- How to Join Section -->
    <section id="how-to-join">
        <!-- How to Join content sama -->
    </section>

    <!-- FAQ Section -->
    <section id="faq">
        <!-- FAQ content sama -->
    </section>

    <!-- Security Section -->
    <section id="security">
        <!-- Security content sama -->
    </section>

    <!-- Footer -->
    <footer>
        <!-- Footer content sama -->
    </footer>

    <!-- Modals -->
    <div class="modal" id="successModal">
        <!-- Success modal content sama -->
    </div>

    <div class="modal" id="errorModal">
        <!-- Error modal content sama -->
    </div>

    <div class="modal" id="connectModal">
        <!-- Connect modal content sama -->
    </div>

    <script>
        // Contract Configuration - DIPERBAIKI
        const CONTRACT_ADDRESS = '0x012da239711B768cEFB745E434fD9C3ac5cD49Da'; // Alamat kontrak yang diberikan
        
        // ABI yang benar sesuai dengan kontrak
        const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_usdtAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fee","type":"uint256"}],"name":"CapitalWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"address","name":"referrer","type":"address"},{"indexed":false,"internalType":"uint256","name":"fee","type":"uint256"}],"name":"Deposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeeCollected","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesAutomaticallyDistributed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ROIClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"level","type":"uint8"}],"name":"ReferralCommission","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"enum BNBNestV7.SalaryTier","name":"tier","type":"uint8"}],"name":"SalaryClaimed","type":"event"},{"inputs":[],"name":"BASE_ROI","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"CAPITAL_WITHDRAWAL_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DEPOSIT_FEE_PERCENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_WALLET","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"LOCK_PERIOD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_ROI","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_DEPOSIT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ROI_STEP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TVL_STEP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"userAddress","type":"address"}],"name":"calculatePendingROI","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"userAddress","type":"address"}],"name":"canClaimSalary","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"userAddress","type":"address"}],"name":"canWithdrawCapital","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimMonthlySalary","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimROI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimReferralRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"distributeFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getContractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentROI","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint8","name":"level","type":"uint8"}],"name":"getReferralCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalFeesCollected","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"userAddress","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"userDeposit","type":"uint256"},{"internalType":"uint256","name":"userDepositTime","type":"uint256"},{"internalType":"uint256","name":"userLastROIClaim","type":"uint256"},{"internalType":"uint256","name":"userClaimedROI","type":"uint256"},{"internalType":"uint256","name":"userReferralRewards","type":"uint256"},{"internalType":"uint256","name":"userLastSalaryClaim","type":"uint256"},{"internalType":"address","name":"userReferrer","type":"address"},{"internalType":"enum BNBNestV7.SalaryTier","name":"userSalaryTier","type":"uint8"},{"internalType":"uint256","name":"userPendingROI","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint8","name":"","type":"uint8"}],"name":"referralCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"referralTiers","outputs":[{"internalType":"uint256","name":"minDeposit","type":"uint256"},{"internalType":"uint256","name":"commissionPercent","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"enum BNBNestV7.SalaryTier","name":"","type":"uint8"}],"name":"salaryConfigs","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"minDeposit","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"setOwner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalFeesCollected","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTVL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdt","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"deposit","type":"uint256"},{"internalType":"uint256","name":"depositTime","type":"uint256"},{"internalType":"uint256","name":"lastROIClaim","type":"uint256"},{"internalType":"uint256","name":"claimedROI","type":"uint256"},{"internalType":"uint256","name":"referralRewards","type":"uint256"},{"internalType":"uint256","name":"lastSalaryClaim","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"enum BNBNestV7.SalaryTier","name":"salaryTier","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawCapital","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        // Global Variables
        let web3;
        let contract;
        let account;
        let usdtContract;

        // Mobile Menu Toggle - tetap sama
        const hamburger = document.getElementById('hamburger');
        const mobileMenu = document.getElementById('mobileMenu');
        const closeMenu = document.getElementById('closeMenu');
        const overlay = document.getElementById('overlay');
        const menuLinks = document.querySelectorAll('.menu-link');

        hamburger.addEventListener('click', () => {
            mobileMenu.classList.add('active');
            overlay.classList.add('active');
        });

        closeMenu.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            overlay.classList.remove('active');
        });

        overlay.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            overlay.classList.remove('active');
        });

        menuLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                overlay.classList.remove('active');
            });
        });

        // FAQ Toggle - tetap sama
        const faqItems = document.querySelectorAll('.faq-item');

        faqItems.forEach(item => {
            const question = item.querySelector('.faq-question');
            
            question.addEventListener('click', () => {
                item.classList.toggle('active');
            });
        });

        // Copy Referral Link - DIPERBAIKI
        const copyLinkBtn = document.getElementById('copyLink');
        const referralLink = document.getElementById('referralLink');

        copyLinkBtn.addEventListener('click', () => {
            if (!account) {
                showConnectModal();
                return;
            }
            
            referralLink.select();
            navigator.clipboard.writeText(referralLink.value).then(() => {
                // Show feedback
                const originalText = copyLinkBtn.innerHTML;
                copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyLinkBtn.innerHTML = originalText;
                }, 2000);
            });
        });

        // Connect Wallet - DIPERBAIKI
        const connectWalletBtn = document.getElementById('connectWallet');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const connectFromModal = document.getElementById('connectFromModal');

        async function connectWallet() {
            try {
                // Check if Web3 is injected by MetaMask
                if (window.ethereum) {
                    web3 = new Web3(window.ethereum);
                    
                    // Check network
                    await checkNetwork();
                    
                    // Request account access
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    
                    // Initialize contract
                    contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                    
                    // Get USDT contract address from BNBNest contract
                    const usdtAddress = await contract.methods.usdt().call();
                    
                    // Initialize USDT contract - DIPERBAIKI untuk USDT (6 decimals)
                    const usdtAbi = [
                        {
                            "constant": false,
                            "inputs": [
                                {"name": "_spender", "type": "address"},
                                {"name": "_value", "type": "uint256"}
                            ],
                            "name": "approve",
                            "outputs": [{"name": "", "type": "bool"}],
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [{"name": "_owner", "type": "address"}],
                            "name": "balanceOf",
                            "outputs": [{"name": "balance", "type": "uint256"}],
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {"name": "_owner", "type": "address"},
                                {"name": "_spender", "type": "address"}
                            ],
                            "name": "allowance",
                            "outputs": [{"name": "", "type": "uint256"}],
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "decimals",
                            "outputs": [{"name": "", "type": "uint8"}],
                            "type": "function"
                        }
                    ];
                    usdtContract = new web3.eth.Contract(usdtAbi, usdtAddress);
                    
                    // Update UI
                    connectWalletBtn.style.display = 'none';
                    walletStatus.style.display = 'block';
                    walletAddress.textContent = account;
                    
                    // Update referral link
                    updateReferralLink();
                    
                    // Check URL for referral parameter
                    checkReferralFromURL();
                    
                    // Load contract data
                    await loadContractData();
                    
                    // Set up event listeners for account changes
                    window.ethereum.on('accountsChanged', function (accounts) {
                        if (accounts.length === 0) {
                            // User disconnected their wallet
                            location.reload();
                        } else {
                            account = accounts[0];
                            walletAddress.textContent = account;
                            updateReferralLink();
                            loadContractData();
                        }
                    });
                    
                    // Network change handler
                    window.ethereum.on('chainChanged', function (chainId) {
                        location.reload();
                    });
                    
                    // Close connect modal if open
                    connectModal.classList.remove('active');
                    
                } else {
                    alert('Please install MetaMask to use this dApp!');
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showError('Error connecting wallet: ' + (error.message || 'Please check your MetaMask and try again.'));
            }
        }

        // Network Check - DIPERBAIKI
        async function checkNetwork() {
            if (window.ethereum) {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                // BSC Mainnet: 0x38, BSC Testnet: 0x61
                if (chainId !== '0x38' && chainId !== '0x61') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }], // BSC Mainnet
                        });
                    } catch (error) {
                        if (error.code === 4902) {
                            // Chain not added, try to add it
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x38',
                                    chainName: 'Binance Smart Chain',
                                    nativeCurrency: {
                                        name: 'BNB',
                                        symbol: 'BNB',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                    blockExplorerUrls: ['https://bscscan.com/']
                                }]
                            });
                        } else {
                            console.error('Error switching network:', error);
                        }
                    }
                }
            }
        }

        function updateReferralLink() {
            if (account) {
                const currentUrl = window.location.href.split('?')[0];
                document.getElementById('referralLink').value = `${currentUrl}?ref=${account}`;
            }
        }

        function checkReferralFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const refAddress = urlParams.get('ref');
            if (refAddress && web3.utils.isAddress(refAddress)) {
                document.getElementById('referrerAddress').value = refAddress;
            }
        }

        connectWalletBtn.addEventListener('click', connectWallet);
        connectFromModal.addEventListener('click', connectWallet);

        // Load Contract Data - DIPERBAIKI
        async function loadContractData() {
            try {
                // Load global stats
                const totalTVL = await contract.methods.totalTVL().call();
                const totalUsers = await contract.methods.totalUsers().call();
                const currentROI = await contract.methods.getCurrentROI().call();
                
                // USDT has 6 decimals, not 18
                const formattedTVL = (parseFloat(totalTVL) / 1e6).toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Calculate ROI based on TVL (0.5% to 2.5% range)
                const tvlInUSD = parseFloat(totalTVL) / 1e6;
                let calculatedROI = 0.5; // Base ROI
                
                if (tvlInUSD >= 1000000) {
                    calculatedROI = 2.5; // Max ROI at $1M TVL
                } else if (tvlInUSD > 0) {
                    // Linear scaling from 0.5% to 2.5% based on TVL
                    calculatedROI = 0.5 + (tvlInUSD / 1000000) * 2;
                    calculatedROI = Math.min(calculatedROI, 2.5); // Cap at 2.5%
                }
                
                document.getElementById('totalTVL').textContent = `$${formattedTVL}`;
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('currentROI').textContent = `${calculatedROI.toFixed(2)}%`;
                document.getElementById('currentTVL').textContent = `$${formattedTVL}`;
                document.getElementById('estimatedROI').textContent = `${calculatedROI.toFixed(2)}%`;
                
                // Load user data if connected
                if (account) {
                    const userInfo = await contract.methods.getUserInfo(account).call();
                    const pendingROI = await contract.methods.calculatePendingROI(account).call();
                    const canWithdraw = await contract.methods.canWithdrawCapital(account).call();
                    
                    // Format user data - USDT has 6 decimals
                    const userDeposit = userInfo.userDeposit / 1e6;
                    const pendingROIFormatted = pendingROI / 1e6;
                    const claimedROIFormatted = userInfo.userClaimedROI / 1e6;
                    const referralRewardsFormatted = userInfo.userReferralRewards / 1e6;
                    
                    document.getElementById('userDeposit').textContent = `${userDeposit.toFixed(2)} USDT`;
                    document.getElementById('pendingROI').textContent = `${pendingROIFormatted.toFixed(2)} USDT`;
                    document.getElementById('claimedROI').textContent = `${claimedROIFormatted.toFixed(2)} USDT`;
                    document.getElementById('referralRewards').textContent = `${referralRewardsFormatted.toFixed(2)} USDT`;
                    
                    // Update withdraw capital button based on lock period
                    const withdrawCapitalBtn = document.getElementById('withdrawCapital');
                    if (canWithdraw) {
                        withdrawCapitalBtn.disabled = false;
                        withdrawCapitalBtn.classList.remove('btn-disabled');
                        withdrawCapitalBtn.classList.add('btn-secondary');
                    } else {
                        withdrawCapitalBtn.disabled = true;
                        withdrawCapitalBtn.classList.add('btn-disabled');
                        withdrawCapitalBtn.classList.remove('btn-secondary');
                    }
                    
                    // Update countdown if user has active deposit
                    if (userInfo.userDeposit > 0) {
                        const depositTime = parseInt(userInfo.userDepositTime);
                        const lockPeriod = 28 * 24 * 60 * 60; // 28 days in seconds
                        const unlockTime = depositTime + lockPeriod;
                        updateCountdown(unlockTime);
                    } else {
                        document.getElementById('countdown').textContent = "No active deposit";
                    }
                }
            } catch (error) {
                console.error('Error loading contract data:', error);
                showError('Error loading contract data: ' + error.message);
            }
        }

        // Invest Function - DIPERBAIKI
        const investBtn = document.getElementById('investBtn');
        const successModal = document.getElementById('successModal');
        const goToDashboardBtn = document.getElementById('goToDashboard');

        investBtn.addEventListener('click', async () => {
            if (!account) {
                showConnectModal();
                return;
            }
            
            const depositAmount = document.getElementById('depositAmount').value;
            const referrerAddress = document.getElementById('referrerAddress').value;
            
            if (!depositAmount || depositAmount < 10) {
                alert('Please enter a valid deposit amount (minimum 10 USDT)');
                return;
            }
            
            try {
                investBtn.disabled = true;
                investBtn.innerHTML = '<div class="loading"></div> Processing...';
                
                // Convert amount to USDT units (USDT has 6 decimals)
                const amount = Math.floor(depositAmount * 1e6).toString();
                const referrer = referrerAddress && web3.utils.isAddress(referrerAddress) ? referrerAddress : '0x0000000000000000000000000000000000000000';
                
                console.log('Deposit amount in USDT units:', amount);
                
                // Check USDT allowance first
                const allowance = await usdtContract.methods.allowance(account, CONTRACT_ADDRESS).call();
                console.log('Current allowance:', allowance);
                
                // Convert to BigNumber
                const allowanceBN = web3.utils.toBN(allowance);
                const depositAmountBN = web3.utils.toBN(amount);
                
                if (allowanceBN.lt(depositAmountBN)) {
                    // Need to approve first
                    investBtn.innerHTML = '<div class="loading"></div> Approving USDT...';
                    
                    const approveTx = await usdtContract.methods.approve(CONTRACT_ADDRESS, amount).send({ 
                        from: account,
                        gas: 100000 
                    });
                    console.log('Approve transaction:', approveTx);
                    
                    // Wait for approval to be processed
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                // Execute deposit transaction
                investBtn.innerHTML = '<div class="loading"></div> Depositing...';
                
                const depositTx = await contract.methods.deposit(amount, referrer).send({ 
                    from: account,
                    gas: 300000 
                });
                console.log('Deposit transaction:', depositTx);
                
                // Show success modal
                successModal.classList.add('active');
                
                // Reload data
                await loadContractData();
                
            } catch (error) {
                console.error('Error depositing:', error);
                
                // Error handling yang lebih detail
                let errorMsg = 'Error processing deposit. ';
                
                if (error.code === 4001) {
                    errorMsg += 'Transaction was rejected by user.';
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMsg += 'Insufficient BNB for gas fees.';
                } else if (error.message && error.message.includes('revert')) {
                    errorMsg += 'Transaction reverted. Please check deposit amount and try again.';
                } else {
                    errorMsg += error.message || 'Please try again.';
                }
                
                showError(errorMsg);
            } finally {
                investBtn.disabled = false;
                investBtn.innerHTML = '<i class="fas fa-rocket"></i> Invest Now';
            }
        });

        // Claim ROI - DIPERBAIKI
        const claimROIBtn = document.getElementById('claimROI');

        claimROIBtn.addEventListener('click', async () => {
            if (!account) {
                showConnectModal();
                return;
            }
            
            try {
                claimROIBtn.disabled = true;
                claimROIBtn.innerHTML = '<div class="loading"></div> Claiming...';
                
                await contract.methods.claimROI().send({ 
                    from: account,
                    gas: 200000 
                });
                
                alert('ROI claimed successfully!');
                await loadContractData();
                
            } catch (error) {
                console.error('Error claiming ROI:', error);
                showError(error.message || 'Error claiming ROI. Please try again.');
            } finally {
                claimROIBtn.disabled = false;
                claimROIBtn.innerHTML = '<i class="fas fa-coins"></i> Claim ROI';
            }
        });

        // Claim Referral Rewards - DIPERBAIKI
        const claimReferralBtn = document.getElementById('claimReferral');

        claimReferralBtn.addEventListener('click', async () => {
            if (!account) {
                showConnectModal();
                return;
            }
            
            try {
                claimReferralBtn.disabled = true;
                claimReferralBtn.innerHTML = '<div class="loading"></div> Claiming...';
                
                await contract.methods.claimReferralRewards().send({ 
                    from: account,
                    gas: 200000 
                });
                
                alert('Referral rewards claimed successfully!');
                await loadContractData();
                
            } catch (error) {
                console.error('Error claiming referral rewards:', error);
                showError(error.message || 'Error claiming referral rewards. Please try again.');
            } finally {
                claimReferralBtn.disabled = false;
                claimReferralBtn.innerHTML = '<i class="fas fa-gift"></i> Claim Referral Rewards';
            }
        });

        // Withdraw Capital - DIPERBAIKI
        const withdrawCapitalBtn = document.getElementById('withdrawCapital');

        withdrawCapitalBtn.addEventListener('click', async () => {
            if (!account) {
                showConnectModal();
                return;
            }
            
            try {
                withdrawCapitalBtn.disabled = true;
                withdrawCapitalBtn.innerHTML = '<div class="loading"></div> Processing...';
                
                await contract.methods.withdrawCapital().send({ 
                    from: account,
                    gas: 200000 
                });
                
                alert('Capital withdrawn successfully!');
                await loadContractData();
                
            } catch (error) {
                console.error('Error withdrawing capital:', error);
                showError(error.message || 'Error withdrawing capital. Please try again.');
            } finally {
                withdrawCapitalBtn.disabled = false;
                withdrawCapitalBtn.innerHTML = '<i class="fas fa-wallet"></i> Withdraw Capital';
            }
        });

        // Modal Functions - tetap sama
        goToDashboardBtn.addEventListener('click', () => {
            successModal.classList.remove('active');
            document.getElementById('dashboard').scrollIntoView({ behavior: 'smooth' });
        });

        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeError = document.getElementById('closeError');

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.add('active');
        }

        closeError.addEventListener('click', () => {
            errorModal.classList.remove('active');
        });

        const connectModal = document.getElementById('connectModal');

        function showConnectModal() {
            connectModal.classList.add('active');
        }

        // Close modals when clicking outside
        [successModal, errorModal, connectModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Countdown Timer - tetap sama
        function updateCountdown(unlockTime) {
            function update() {
                const now = Math.floor(Date.now() / 1000);
                const distance = unlockTime - now;
                
                if (distance < 0) {
                    document.getElementById('countdown').textContent = "Unlocked!";
                    // Enable withdraw button when unlocked
                    const withdrawCapitalBtn = document.getElementById('withdrawCapital');
                    withdrawCapitalBtn.disabled = false;
                    withdrawCapitalBtn.classList.remove('btn-disabled');
                    withdrawCapitalBtn.classList.add('btn-secondary');
                    return;
                }
                
                const days = Math.floor(distance / (60 * 60 * 24));
                const hours = Math.floor((distance % (60 * 60 * 24)) / (60 * 60));
                const minutes = Math.floor((distance % (60 * 60)) / 60);
                const seconds = Math.floor(distance % 60);
                
                document.getElementById('countdown').textContent = 
                    `${days} days ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            update();
            setInterval(update, 1000);
        }

        // Smooth scrolling for anchor links - tetap sama
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                
                const targetId = this.getAttribute('href');
                if (targetId === '#') return;
                
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Auto-connect if already authorized - DIPERBAIKI
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        account = accounts[0];
                        web3 = new Web3(window.ethereum);
                        contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                        
                        // Get USDT contract
                        const usdtAddress = await contract.methods.usdt().call();
                        const usdtAbi = [
                            {
                                "constant": false,
                                "inputs": [
                                    {"name": "_spender", "type": "address"},
                                    {"name": "_value", "type": "uint256"}
                                ],
                                "name": "approve",
                                "outputs": [{"name": "", "type": "bool"}],
                                "type": "function"
                            },
                            {
                                "constant": true,
                                "inputs": [{"name": "_owner", "type": "address"}],
                                "name": "balanceOf",
                                "outputs": [{"name": "balance", "type": "uint256"}],
                                "type": "function"
                            },
                            {
                                "constant": true,
                                "inputs": [
                                    {"name": "_owner", "type": "address"},
                                    {"name": "_spender", "type": "address"}
                                ],
                                "name": "allowance",
                                "outputs": [{"name": "", "type": "uint256"}],
                                "type": "function"
                            },
                            {
                                "constant": true,
                                "inputs": [],
                                "name": "decimals",
                                "outputs": [{"name": "", "type": "uint8"}],
                                "type": "function"
                            }
                        ];
                        usdtContract = new web3.eth.Contract(usdtAbi, usdtAddress);
                        
                        connectWalletBtn.style.display = 'none';
                        walletStatus.style.display = 'block';
                        walletAddress.textContent = account;
                        updateReferralLink();
                        checkReferralFromURL();
                        
                        await loadContractData();
                    }
                } catch (error) {
                    console.error('Error in auto-connect:', error);
                }
            }
        });

        // Add wallet check for all action buttons
        const actionButtons = [
            claimROIBtn, withdrawCapitalBtn, investBtn, claimReferralBtn
        ];

        actionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                if (!account) {
                    e.preventDefault();
                    showConnectModal();
                    return false;
                }
            });
        });
    </script>
</body>
</html>
